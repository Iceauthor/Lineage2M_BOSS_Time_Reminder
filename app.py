from apscheduler.schedulers.background import BackgroundScheduler
import os
import json
import psycopg2
from flask import Flask, request, abort
from dotenv import load_dotenv
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
from datetime import datetime, timedelta
import pytz


load_dotenv()
app = Flask(__name__)
line_bot_api = LineBotApi(os.getenv("LINE_CHANNEL_ACCESS_TOKEN"))
handler = WebhookHandler(os.getenv("LINE_CHANNEL_SECRET"))

def get_db_connection():
    return psycopg2.connect(
        host=os.getenv("DB_HOST"),
        port=os.getenv("DB_PORT"),
        user=os.getenv("DB_USER"),
        password=os.getenv("DB_PASSWORD"),
        dbname=os.getenv("DB_NAME")
    )

def get_respawn_hours_by_name(name):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT respawn_hours FROM boss_list WHERE display_name = %s", (name,))
    result = cursor.fetchone()
    cursor.close()
    conn.close()
    return result[0] if result else None


# Ëá™ÂãïÊ∏ÖÁêÜÈáçË§á boss_aliases ‰∏¶Âª∫Á´ãÂîØ‰∏ÄÁ¥¢Âºï
def cleanup_boss_aliases():
    try:
        def cleanup_boss_aliases():
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute("""
                DELETE FROM boss_aliases a
                USING boss_aliases b
                WHERE a.id < b.id
                  AND a.boss_id = b.boss_id
                  AND a.keyword = b.keyword
            """)
            cursor.execute("""
                DO $$
                BEGIN
                    IF NOT EXISTS (
                        SELECT 1 FROM pg_indexes WHERE indexname = 'unique_boss_keyword'
                    ) THEN
                        CREATE UNIQUE INDEX unique_boss_keyword ON boss_aliases(boss_id, keyword);
                    END IF;
                END$$;
            """)
            conn.commit()
            cursor.close()
            conn.close()
            print("‚úÖ Â∑≤Ê∏ÖÈô§ÈáçË§á boss_aliases\n‚úÖ Â∑≤Âª∫Á´ãÂîØ‰∏ÄÁ¥¢Âºï")

    except Exception as e:
        print("‚ùå Ê∏ÖÁêÜ/Á¥¢ÂºïÂª∫Á´ãÂ§±ÊïóÔºö", e)


# Ëá™ÂãïÂåØÂÖ• boss_list.json Ë≥áÊñô
def auto_insert_boss_list():
    print("üöÄ Âü∑Ë°å BOSS Ëá™ÂãïÂåØÂÖ•")
    conn = get_db_connection()
    cursor = conn.cursor()

    with open("boss_list.json", "r", encoding="utf-8") as f:
        bosses = json.load(f)

    # Ê∏ÖÁ©∫ËàäÊúâË≥áÊñô
    cursor.execute("DELETE FROM boss_aliases")
    cursor.execute("DELETE FROM boss_list")
    print("‚úÖ Â∑≤Ê∏ÖÈô§ boss_list Ëàá boss_aliases Ë≥áÊñô")

    for boss in bosses:
        display_name = boss["display_name"]
        respawn_hours = boss["respawn_hours"]
        keywords = boss["keywords"]

        # Êñ∞Â¢û boss ‰∏ªË≥áÊñô
        cursor.execute("""
            INSERT INTO boss_list (display_name, respawn_hours) 
            VALUES (%s, %s) RETURNING id
        """, (display_name, respawn_hours))
        boss_id = cursor.fetchone()[0]

        # Êñ∞Â¢ûÂ∞çÊáâ keyword
        for keyword in keywords:
            cursor.execute("""
                INSERT INTO boss_aliases (boss_id, keyword)
                VALUES (%s, %s)
            """, (boss_id, keyword.lower()))

    conn.commit()
    cursor.close()
    conn.close()
    print("‚úÖ BOSS Ë≥áÊñôÂåØÂÖ•ÂÆåÊàê")



# ÂïüÂãïÊôÇÂÖàÂü∑Ë°å‰∏ÄÊ¨°Ê∏ÖÁêÜ + ÂåØÂÖ•
cleanup_boss_aliases()
auto_insert_boss_list()


@app.route("/", methods=["GET"])
def home():
    return "‚úÖ Lineage2M BOSS Reminder Bot is running."

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'


@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    text = event.message.text.strip()
    group_id = event.source.group_id if event.source.type == "group" else "single"
    
    # ËôïÁêÜ K ÂÖã4 170124ÔºàÁï∂Êó•ÊåáÂÆöÊôÇÈñìÔºâ
    if text.lower().startswith("k "):
        parts = text.split()
        if len(parts) == 3 and parts[2].isdigit() and len(parts[2]) == 6:
            _, keyword, timestr = parts
            try:
                hour = int(timestr[0:2])
                minute = int(timestr[2:4])
                second = int(timestr[4:6])
                tz = pytz.timezone("Asia/Taipei")
                kill_time = datetime.now(tz).replace(hour=hour, minute=minute, second=second, microsecond=0)

                conn = get_db_connection()
                cursor = conn.cursor()
                keyword = keyword.lower()
                cursor.execute("""
                    SELECT b.id, b.display_name, b.respawn_hours
                    FROM boss_aliases a
                    JOIN boss_list b ON a.boss_id = b.id
                    WHERE a.keyword = %s
                """, (keyword,))
                row = cursor.fetchone()
                if row:
                    boss_id, display_name, respawn_hours = row
                    respawn_time = kill_time + timedelta(hours=respawn_hours)
                    cursor.execute(
                        "INSERT INTO boss_tasks (boss_id, group_id, kill_time, respawn_time) VALUES (%s, %s, %s, %s)",
                        (boss_id, group_id, kill_time, respawn_time)
                    )
                    conn.commit()
                    reply_text = f"\n\nüî¥ ÊìäÊÆ∫Ôºö{display_name}\nüïì Ê≠ª‰∫°Ôºö{kill_time.strftime('%Y-%m-%d %H:%M:%S')}\nüü¢ ÈáçÁîüÔºö{respawn_time.strftime('%Y-%m-%d %H:%M:%S')}"
                else:
                    reply_text = "‚ùå Êâæ‰∏çÂà∞Ë©≤ BOSS ÈóúÈçµÂ≠ó„ÄÇ"
                cursor.close()
                conn.close()
            except:
                reply_text = "‚ùå ÊôÇÈñìÊ†ºÂºèÈåØË™§ÔºåË´ã‰ΩøÁî® K ÂÖã4 170124 ÁöÑÊ†ºÂºè„ÄÇ"
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
            return

    # ËôïÁêÜ /clear all Êåá‰ª§ÔºöÊ∏ÖÈô§Ë©≤Áæ§ÁµÑÊâÄÊúâ BOSS Á¥ÄÈåÑ
    if text.lower().strip() == "/clear all":
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("DELETE FROM boss_tasks WHERE group_id = %s", (group_id,))
        conn.commit()
        cursor.close()
        conn.close()
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text="‚úÖ Â∑≤Ê∏ÖÈô§Êú¨Áæ§ÁµÑÊâÄÊúâ BOSS Á¥ÄÈåÑ"))
        return

# ËôïÁêÜ kr1„ÄÅkr2 ÂÖã4 170124 Ê†ºÂºèÔºåÊåáÂÆöÂâçÊó•ÊàñÂâçÂÖ©Êó•Ê≠ª‰∫°ÊôÇÈñì
    if text.lower().startswith("kr1 ") or text.lower().startswith("kr2 "):
        parts = text.split()
        if len(parts) == 3:
            prefix, keyword, timestr = parts
            try:
                hour = int(timestr[0:2])
                minute = int(timestr[2:4])
                second = int(timestr[4:6])
                offset_days = 1 if prefix.lower() == "kr1" else 2
                kill_time = datetime.now(pytz.timezone("Asia/Taipei")) - timedelta(days=offset_days)
                kill_time = kill_time.replace(hour=hour, minute=minute, second=second, microsecond=0)

                conn = get_db_connection()
                cursor = conn.cursor()
                keyword = keyword.lower()
                cursor.execute("""
                    SELECT b.id, b.display_name, b.respawn_hours
                    FROM boss_aliases a
                    JOIN boss_list b ON a.boss_id = b.id
                    WHERE a.keyword = %s
                """, (keyword,))
                row = cursor.fetchone()
                if row:
                    boss_id, display_name, respawn_hours = row
                    respawn_time = kill_time + timedelta(hours=respawn_hours)
                    cursor.execute(
                        "INSERT INTO boss_tasks (boss_id, group_id, kill_time, respawn_time) VALUES (%s, %s, %s, %s)",
                        (boss_id, group_id, kill_time, respawn_time)
                    )
                    conn.commit()
                    reply_text = f"\n\nüî¥ ÊìäÊÆ∫Ôºö{display_name}\nüïì Ê≠ª‰∫°Ôºö{kill_time.strftime('%Y-%m-%d %H:%M:%S')}\nüü¢ ÈáçÁîüÔºö{respawn_time.strftime('%Y-%m-%d %H:%M:%S')}"
                else:
                    reply_text = "‚ùå Êâæ‰∏çÂà∞Ë©≤ BOSS ÈóúÈçµÂ≠ó„ÄÇ"
                cursor.close()
                conn.close()
            except:
                reply_text = "‚ùå ÊôÇÈñìÊ†ºÂºèÈåØË™§ÔºåË´ã‰ΩøÁî® kr1 ÂÖã4 170124 ÁöÑÊ†ºÂºè„ÄÇ"
        else:
            reply_text = "‚ùå Êåá‰ª§Ê†ºÂºèÈåØË™§ÔºåË´ã‰ΩøÁî® kr1 ÂÖã4 170124 ÁöÑÊ†ºÂºè„ÄÇ"
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        return
    # ËôïÁêÜ K„ÄÅk Êåá‰ª§‰ΩúÁÇ∫ÊìäÊÆ∫Á¥ÄÈåÑ
    if text.lower().startswith("k "):
        keyword = text[2:].strip()
        conn = get_db_connection()
        cursor = conn.cursor()
        keyword = keyword.lower()
        cursor.execute("""
            SELECT b.id, b.display_name, b.respawn_hours
            FROM boss_aliases a
            JOIN boss_list b ON a.boss_id = b.id
            WHERE a.keyword = %s
        """, (keyword,))
        row = cursor.fetchone()
        if row:
            boss_id, display_name, respawn_hours = row
            now = datetime.now(pytz.timezone('Asia/Taipei'))
            respawn_time = now + timedelta(hours=respawn_hours)
            cursor.execute(
                "INSERT INTO boss_tasks (boss_id, group_id, kill_time, respawn_time) VALUES (%s, %s, %s, %s)",
                (boss_id, group_id, now, respawn_time)
            )
            conn.commit()
            reply_text = f"\n\nüî¥ ÊìäÊÆ∫Ôºö{display_name}\nüïì Ê≠ª‰∫°Ôºö{now.strftime('%Y-%m-%d %H:%M:%S')}\nüü¢ ÈáçÁîüÔºö{respawn_time.strftime('%Y-%m-%d %H:%M:%S')}"
        else:
            reply_text = "‚ùå ÁÑ°Ê≥ïËæ®Ë≠òÁöÑÈóúÈçµÂ≠óÔºåË´ãÂÖà‰ΩøÁî® add Êåá‰ª§Êñ∞Â¢û„ÄÇ"
        cursor.close()
        conn.close()
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        return

    text = event.message.text.strip().lower()
    group_id = event.source.group_id if event.source.type == "group" else "single"
    if text in ["kb all", "Âá∫"]:
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("""
            SELECT b.display_name, t.latest_respawn_time, b.respawn_hours
            FROM boss_list b
            LEFT JOIN (
                SELECT DISTINCT ON (boss_id)
                    boss_id, respawn_time AS latest_respawn_time
                FROM boss_tasks
                WHERE group_id = %s
                ORDER BY boss_id, respawn_time DESC
            ) t ON b.id = t.boss_id
            ORDER BY 
                CASE WHEN t.latest_respawn_time IS NULL THEN 1 ELSE 0 END, 
                t.latest_respawn_time ASC
        """, (group_id,))
        results = cursor.fetchall()
        print(f"üìä Êü•Ë©¢ÁµêÊûúÔºö{results}")
        cursor.close()
        conn.close()

        tz = pytz.timezone('Asia/Taipei')
        now = datetime.now(tz)
        next_24hr = now + timedelta(hours=24)
        lines = ["üïì Êé•‰∏ã‰æÜ 24 Â∞èÊôÇÂÖßÈáçÁîü BOSSÔºö\n"]

        for name, time, hours in results:
            if time:
                time = time.replace(tzinfo=tz)
                if now <= time <= next_24hr:
                    lines.append(f"{time.strftime('%H:%M:%S')} {name}\n")
                elif now > time:
                    if hours:
                        delta = now - time
                        cycles = int(delta.total_seconds() // (hours * 3600)) + 1
                        lines.append(f"{time.strftime('%H:%M:%S')} {name}„ÄêÈÅé{cycles}„Äë\n")
                    else:
                        lines.append(f"{time.strftime('%H:%M:%S')} {name}\n")
                else:
                    lines.append(f"{time.strftime('%H:%M:%S')} {name}\n")
            else:
                lines.append(f"__:__:__ {name}\n")

        reply_text = ''.join(lines)
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))


# Ëá™ÂãïÊé®Êí≠ÔºöÈáçÁîüÊôÇÈñìÂÄíÊï∏ÂÖ©ÂàÜÈêòÊèêÈÜí
def reminder_job():
    try:
        now = datetime.now(tz)
        soon = now + timedelta(minutes=2)
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("""
            SELECT b.display_name, t.group_id, t.respawn_time
            FROM boss_tasks t
            JOIN boss_list b ON b.id = t.boss_id
            WHERE t.respawn_time BETWEEN %s AND %s
        """, (now, soon))
        results = cursor.fetchall()
        for name, group_id, respawn in results:
            try:
                msg = f"*{name}* Âç≥Â∞áÂá∫Áèæ"
                line_bot_api.push_message(group_id, TextSendMessage(text=msg))
            except Exception as e:
                print(f"‚ùå ÊèêÈÜíÂ§±ÊïóÔºö{e}")
        cursor.close()
        conn.close()
    except Exception as e:
        print("‚ùå ÊéíÁ®ãÊèêÈÜíÈåØË™§Ôºö", e)


if __name__ == "__main__":
    scheduler = BackgroundScheduler()
    scheduler.add_job(reminder_job, "interval", minutes=1)
    scheduler.start()
    app.run(port=5000)
    